import
  strutils, sequtils, pegs, future,
  gameObjects/gameObjects, dexes/dexes, gameData/gameData

type

  PokeTokens = object
    name, item, ability: string
    level: int
    nature: PokeNature
    evs, ivs: PokeStats
    moves: seq[string]

proc parseStatSpread(statString: string, default = 0): PokeStats =
  result = (hp: default, atk: default, def: default, spa: default, spd: default, spe: default)
  for stat in split(statString, '/'):
    if stat =~ peg"\s* {\d*} \s* i'hp' \s*":
      result = (hp: parseInt(matches[0]), atk: result.atk, def: result.def, spa: result.spa, spd: result.spd, spe: result.spe)
    elif stat =~ peg"\s* {\d*} \s* i'atk' \s*":
      result = (hp: result.hp, atk: parseInt(matches[0]), def: result.def, spa: result.spa, spd: result.spd, spe: result.spe)
    elif stat =~ peg"\s* {\d*} \s* i'def' \s*":
      result = (hp: result.hp, atk: result.atk, def: parseInt(matches[0]), spa: result.spa, spd: result.spd, spe: result.spe)
    elif stat =~ peg"\s* {\d*} \s* i'spa' \s*":
      result = (hp: result.hp, atk: result.atk, def: result.def, spa: parseInt(matches[0]), spd: result.spd, spe: result.spe)
    elif stat =~ peg"\s* {\d*} \s* i'spd' \s*":
      result = (hp: result.hp, atk: result.atk, def: result.def, spa: result.spa, spd: parseInt(matches[0]), spe: result.spe)
    elif stat =~ peg"\s* {\d*} \s* i'spe' \s*":
      result = (hp: result.hp, atk: result.atk, def: result.def, spa: result.spa, spd: result.spd, spe: parseInt(matches[0]))
  
proc tokenize(teamString: string): seq[PokeTokens] =
  result = @[]
  for line in split(teamString, '\n'):
    if line =~ peg"\s* {(\w / '-')+} \s* '@' \s* {(\w / '-' / \s)*}":
      result.add(PokeTokens(
        name: "", item: "", ability: "", level: 100, evs: (hp: 0, atk: 0, def: 0, spa: 0, spd: 0, spe: 0),
        ivs: (hp: 0, atk: 0, def: 0, spa: 0, spd: 0, spe: 0), nature: pnBashful, moves: @[])
      )
      result[result.len - 1].name = matches[0]
      result[result.len - 1].item = matches[1]
    elif line =~ peg"\s* 'Ability:' \s* {(\w / '-' / \s)*}":
      result[result.len - 1].ability = matches[0]
    elif line =~ peg"\s* 'Level:' \s* {\d*} \s*":
      result[result.len - 1].level = parseInt(matches[0])
    elif line =~ peg"\s* 'EVs:' \s* {(\w / \s / '/')*}":
      result[result.len - 1].evs = parseStatSpread(matches[0])
    elif line =~ peg"\s* 'IVs:' \s* {(\w / \s / '/')*}":
      result[result.len - 1].ivs = parseStatSpread(matches[0], 31)
    elif line =~ peg"\s* '-' \s* {.*}":
      result[result.len - 1].moves.add(matches[0])
    elif line =~ peg"\s* {\w*} \s* 'Nature' \s*":
      result[result.len - 1].nature = stringToNature(matches[0])

proc parseTeam(teamString: string, side: TeamSideKind): Team =
  var pokeTokens = tokenize(teamString)
  var pokemonSeq: seq[Pokemon] = @[]
  for idx, token in pokeTokens:
    let moves = token.moves.map((moveString) => getPokeMove(moveString.strip))
    let item: Item = nil
    let ability: Ability = nil
    let gender = pgkFemale
    let pokeSet = PokemonSet(
      moves: moves, item: item, ability: ability, gender: gender,
      level: token.level, evs: token.evs, ivs: token.ivs, nature: token.nature
    )
    let data = getPokemonData(token.name)
    pokemonSeq.add(makePokemon(data, pokeSet, side))
  makeTeam(pokemonSeq, side)


const teamString = """
Xerneas @ Choice Specs  
Ability: Fairy Aura  
Level: 50  
EVs: 252 SpA / 4 SpD / 252 Spe  
Timid Nature  
IVs: 0 Atk  
- Moonblast  
- Dazzling Gleam  
- Grass Knot  
- Psychic  

Yveltal @ Black Glasses  
Ability: Dark Aura  
Level: 50  
EVs: 252 Atk / 4 SpD / 252 Spe  
Adamant Nature  
- Sucker Punch  
- Protect  
- Knock Off  
- Snarl  

Mantine @ Iapapa Berry  
Ability: Water Absorb  
Level: 50  
EVs: 252 HP / 76 Def / 180 SpD  
Calm Nature  
IVs: 0 Atk  
- Icy Wind  
- Helping Hand  
- Wide Guard  
- Haze  

Whimsicott @ Focus Sash  
Ability: Prankster  
Level: 50  
EVs: 252 HP / 4 SpD / 252 Spe  
Timid Nature  
IVs: 0 Atk  
- Tailwind  
- Light Screen  
- Grass Knot  
- Encore  

Incineroar @ Assault Vest  
Ability: Intimidate  
Level: 50  
EVs: 76 HP / 252 Atk / 4 Def / 12 SpD / 164 Spe  
Adamant Nature  
- U-turn  
- Flare Blitz  
- Fake Out  
- Knock Off  

Landorus-Therian @ Choice Scarf  
Ability: Intimidate  
Level: 50  
EVs: 252 Atk / 4 SpD / 252 Spe  
Jolly Nature  
- Earthquake  
- U-turn  
- Rock Slide  
- Superpower  
"""


discard parseTeam(teamString, tskHome)
